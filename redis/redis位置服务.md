附近的人，滴滴打车，附近的餐馆类似这些需求到底是如何实现的呢？

今天这篇文章我们学习下redis的GEO数据结构，一种专门针对位置信息服务的数据结构，也叫LBS（Location-Based Service，LBS）

### 面向位置服务的LBS
首先不管是人、车的位置信息都会按照经纬度来记录，经度的范围[-180,180],纬度的范围[-90,90]，纬度正负以赤道为界，北正南负，经度正负以
本初子午线为界，东正西负。比如北京的坐标(116.37，39.86)，都是正数。因为中国位于东北半球。

#### GEOHash算法
GEOHash算法是业内比较通用的地理位置距离排序算法。redis就是使用这个算法将二维的经纬度数据映射到一维的整数。
GEOHash都对经纬度的计算，都是采用的二分法切割来计算。首先我们会定义一个N作为切割次数，N越大位置越精确。假设此时N=5，我们要切割五次，那么对经度的划分就如下图
![经度切分](https://static001.geekbang.org/resource/image/3c/f2/3cb007yy63c820d6dd2e4999608683f2.jpg)

如图所见，首先将[-180,180]二分成了[-180,0], [0,180]两个段，116.37，在后一段，所以GEOHash记录为1，然后继续拆分[0,180]为[0,90],[90,180]，还是在
右边又记录为1，以此内推，我们最终切割N次后得到了编码11010的一维数据代表了经度116.37。再次提醒，N越大，我们的坐标范围就会更精确。

纬度的切分也一样，如图：
![xxx](https://static001.geekbang.org/resource/image/65/6d/65f41469866cb94963b4c9afbf2b016d.jpg)

最终得到纬度的一维表示10111

然后我们将其融合，融合的规则是：最终编码值的偶数位上依次是经度的编码值，奇数位上依次是纬度的编码值，其中，偶数位从 0 开始，奇数位从 1 开始。如图：
![](https://static001.geekbang.org/resource/image/4a/87/4a8296e841f18ed4f3a554703ebd5887.jpg)

最终我们将二维坐标(116.37，39.90)表示成1110011101。

那么具体怎么计算附近的xx呢，举个例子。我们把经度区间[-180,180]做一次二分区，把纬度区间[-90,90]做一次二分区，就会得到 4 个分区。我们来看下它们的经度和纬度范围以及对应的 GeoHash 组合编码。
![](https://static001.geekbang.org/resource/image/2a/74/2a2a650086acf9700c0603a4be8ceb74.jpg)

- 分区一：[-180,0) 和[-90,0)，编码 00；
- 分区二：[-180,0) 和[0,90]，编码 01；
- 分区三：[0,180]和[-90,0)，编码 10；
- 分区四：[0,180]和[0,90]，编码 11。

这 4 个分区对应了 4 个方格，每个方格覆盖了一定范围内的经纬度值，分区越多，每个方格能覆盖到的地理空间就越小，也就越精准。我们把所有方格的编码值映射到一维空间时，相邻方格的 GeoHash 编码值基本也是接近的.

这样我们就可以按照zset的方式去计算处理附近的人了。因为Geo本来就是个zset的结构。
- GEOADD 命令：用于把一组经纬度信息和相对应的一个 ID 记录到 GEO 类型集合中；
- GEORADIUS 命令：会根据输入的经纬度位置，查找以这个经纬度为中心的一定范围内的其他元素。当然，我们可以自己定义这个范围。